# Pseudo C Dump (v1.1)

Author: **Asher Davila L.**

_Binary Ninja plugin to dump the Pseudo C generated by Binja into a folder._

## Description:

This Binary Ninja plugin is written in Python 3 and it aims to assist with reverse engineering  and vulnerability research. It dumps the Pseudo C representation of a binary, generated by Binja's decompiler, into a specified folder. 

Even though Binja has a built-in File -> Export option, it saves the output into a single file and contains extra information such as Segments, Sections, memory addresses, and other information that might not be necessary, depending on the intended use of the generated output.

The motivation for writing this plugin is to extract the Pseudo C representation of a binary in a format that can be easily imported into an IDE, or parsed by static analysis tools like [Semgrep](https://github.com/returntocorp/semgrep).

PCDump-bn plugin is inspired by [atxsinn3r](https://github.com/atxsinn3r)'s Binja plugin, [BinjaHLILDump](https://github.com/atxsinn3r/BinjaHLILDump), which dumps the HLIL, and by [0xdea](https://github.com/0xdea) Ghidra's [plugin](https://github.com/0xdea/ghidra-scripts/blob/main/Haruspex.java), which dumps the pseudo-code generated by the Ghidra decompiler.

### Usage

When using pcdump, a shell will pop up expecting input in a manner resembling the following:

```
usage: pcdump [-h] [--func FUNC] [--range RANGE] [--recursive]
              [--write_location WRITE_LOCATION] [--dirless] [-s]

options:
  -h, --help            show this help message and exit
  --func FUNC, -f FUNC  functions name or address to parse
  --range RANGE         range, specified as a string separated by a -
  --recursive, -r       recursive, if the function has a call pull that too
  --write_location WRITE_LOCATION, -w WRITE_LOCATION
                        location to write the output to
  --dirless, -d         write and don't create directory
  -s, --solo            location to write the output to
```

## The output, and how to get it into a compilable state

What will be dumped are c files. As of November 11th 2024, the unfortunate caveats to this process are:

- Binja often types as `void*` and then dereferences it.
  - The solution I had for this was just find and replace `void*` with `void**`, for double dereferences this fails. Casting to some intuitive `size_t` may also be a good solution.
  - but due to some variables being double dereferenced, haven't found a solid solution to this yet.
- Binja won't be afraid to add a float to a pointer then deref.
- Binja will name some conditional variables like `cond:N`.
  - The solution I found was to find and replace all instances of `cond:` with `cond_`.
- The files generated are c, though they have some c++ macros like `nullptr`.
  - I define `nullptr` as `NULL`.
- The files generated also use the `bool` type.
  - I define `bool` as `int`.

## pc_dumpstats.json

The following are the components of the statistics file named `pc_dumpstats.json`. That file will track what and how pseudo_c has analyzed routines, and also acts as directions for what it should do on deompilation passes.

**NOTE:** The term READ ONLY means that pseudo_c is supposed to write it, not the user. The term READ WRITE in this case means that the user can add definitions to it.

### function list

**READ ONLY** list of functions. This will just track if a function has already been decompiled or not. Unless user specifies to overwrite the function list, will only add a new function if a new function has been decompiled.

### include list

**READ ONLY** list of includes. Generated each time regardless to satisfy the decompiled functions includes, or add to the already generated list. Tracks as `address of include:name`.

### object list

**READ ONLY** list of objects. This is only tracked so that if a new c file needs a new object, it can use the generated object for reference so it doesn't generate it twice.

#### cases:

- object is actually a string, and the string is being added as a global.
  
  - POTENTIALLY we could check if the hlil ever has an instance that writes to the global, and if not wwe can assume that its not written means that it can stay a read only global-removing all `global-xxx` variables. However, because this allows so much variance we aren't gonna mess with globals, as I've already seen more than one use case where a string is used and then written to, invalidating those hopes.

### alias list

**READ WRITE** list of aliases. These are added as a regular expression string and suggested addresses, along with who the alias is. After the alias is complete, instead of having the include in the include file, `pseudoc_aliases.h` will have the new macro defining the replacement, FE `some_printf_2` could be defined as 

```c
#define some_printf_2 printf
```

#### cases:

- Iteration 1 you have an include, and iteration 2 an alias uses the same name in its keys
  
  - The include will be removed in place of the alias, aliases have priority in that case.
  
  - Also, include files will be generated on each iteration, so that the old instance will automatically be removed.

### black list

**READ WRITE** functions that will be added to the include list, but not decompiled. These are added as a regular expression string, and suggested addresses.

### TODO

- Its definitely in the `TODO` to implement some of these in the file generation process.
- The other `TODO` would be to do header tracking, so that the generated c files can have all their includes resolved for eachother.
- Get binja to stop creating local variables of type void.
- correct decompilation so that there are no more `char cont* const` types that are written to. These guys are annoying.
- Have sidekick stop generating function names with `<>` in the name.
- Cast function pointers to their interpretted types in pseudo-c view before the call.

## Minimum Version

This plugin requires the following minimum version of Binary Ninja:

* 3814

## Contributing

Any feedback and any help from external maintainers are appreciated.

* Create an [issue](https://github.com/AsherDLL/PCDump-bn/issues) for feature requests or bugs that you have found.

* Submit a pull request for fixes and enhancements for this tool.

## License

This plugin is released under an [Apache 2.0 License](./LICENSE).
